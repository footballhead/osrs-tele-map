<!DOCTYPE html>
<head>
    <title>OSRS Teleport Map</title>
    <style>
        /* https://stackoverflow.com/questions/1664785/resize-html5-canvas-to-fit-window */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0px;
            font-family: sans-serif;
        }
        canvas {
            display: block;
        }
        #dialog {
            position: absolute;
            left: 0px;
            top: 0px;
            background-color: white;
            border: solid black 1px;
            padding: 4px;
            display: none;
            /* dynamic elements: display, top, left */
        }
        #dialog > p, #dialog > div > p {
            margin-top: 0px;
        }
    </style>
</head>
<body>
    <canvas id="mainCanvas">Interactive map of Oldschool Runescape teleportation locations.</canvas>

    <img id="mapImg" src="Old_School_RuneScape_world_map.png" style="display: none;">
    <img id="runeFire" src="https://oldschool.runescape.wiki/images/a/a2/Fire_rune.png" style="display: none;">
    <img id="runeAir" src="https://oldschool.runescape.wiki/images/b/bf/Air_rune.png" style="display: none;">
    <img id="runeLaw" src="https://oldschool.runescape.wiki/images/f/f6/Law_rune.png" style="display: none;">

    <!-- it is important that there is no space between the div and p elements so that dialog.firstChild is not some random text -->
    <div id="dialog"><p>Hello world</p>
        <button id="dialogCloseButton">Close</button>
    </div>

    <script>
        (function() {
            const scaleIncrements = 0.05;
            const scaleMin = 0.1;
            const poiRadius = 10;

            var canvas = document.getElementById('mainCanvas');
            var ctx = canvas.getContext('2d');
            var mapImg = document.getElementById('mapImg');

            var dialog = document.getElementById('dialog');
            var dialogCloseButton = document.getElementById('dialogCloseButton');

            var mapImgLoaded = false;

            var isDragging = false;
            var mapX = 0;
            var mapY = 0;
            var mapScale = 1;

            var prevMouseX = 0;
            var prevMouseY = 0;

            //
            // HTML DOM helpers
            //

            function a(link, text) {
                var anchor = document.createElement('a');
                anchor.href = link;
                // TODO: anchor.target
                anchor.appendChild(document.createTextNode(text));
                return anchor;
            }

            function text(txt) {
                return document.createTextNode(txt);
            }

            function img(src) {
                var img = document.createElement('img');
                img.src = src;
                // TODO: alt text
                return img;
            }

            function span(...children) {
                var span = document.createElement('span');
                children.forEach(child => span.appendChild(child));
                return span;
            }

            function p(...children) {
                var p = document.createElement('p');
                children.forEach(child => p.appendChild(child));
                return p;
            }

            function div(...children) {
                var div = document.createElement('div');
                children.forEach(child => div.appendChild(child));
                return div;
            }

            //
            // Helpers to tap into OSRS wiki
            //

            function aWiki(text) {
                const wikiBase = 'https://oldschool.runescape.wiki/w/';
                return a(wikiBase + text, text);
            }

            function imgWiki(src) {
                // My suspicion is that the image is stored at a location based on the hash of the file contents.
                // The first directory after wikiBase is the first hex of the hash (0-9a-f) for organization.
                // Then the subdirectory is the first and second hex of the hash.
                // Then the file name follows.
                const wikiBase = 'https://oldschool.runescape.wiki/images/';
                // TODO: alt text
                return img(wikiBase + src.slice(0, 1) + '/' + src);
            }

            function imgRune(rune) {
                switch (rune.toLowerCase()) {
                    case 'air': return imgWiki('bf/Air_rune.png');
                    case 'blood': return imgWiki('2a/Blood_rune.png');
                    case 'earth': return imgWiki('d2/Earth_rune.png');
                    case 'fire': return imgWiki('a2/Fire_rune.png');
                    case 'law': return imgWiki('f6/Law_rune.png');
                    case 'soul': return imgWiki('9b/Soul_rune.png');
                    case 'water': return imgWiki('d1/Water_rune.png');
                    case 'banana': return imgWiki('69/Banana.png');
                }
            }

            //
            // Templates, to make tooltip code more readable and consistent
            //

            function reqAncientMagicks() {
                return p(text('Requires '), aWiki('Ancient Magicks'), text(' spellbook'));
            }

            function reqMagic(magic) {
                return p(text('Requires ' + magic + ' Magic'));
            }

            function runeReq(rune, amt) {
                return span(imgRune(rune), text('x' + amt + ' '));
            }

            function teleToHouseTemplate(loc) {
                return div(
                    p(imgWiki('88/Teleport_to_House.png'), aWiki('Teleport to House')),
                    p(text('Requires a house in '), a('https://oldschool.runescape.wiki/w/Player-owned_house', loc)),
                    reqMagic(40),
                    p(runeReq('air', 1), runeReq('earth', 1), runeReq('law', 1))
                );
            }

            //
            // Points of Interest
            //

            /* https://oldschool.runescape.wiki/w/Teleportation */
            var poi = [
                {
                    name: 'Ectophial',
                    x: 7520,
                    y: 1732,
                    color: 'yellow',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('bc/Ectophial.png'), aWiki('Ectophial')),
                            p(text('Requires completing '), aWiki('Ghosts Ahoy'))
                        );
                    }
                },
                {
                    name: 'Explorer\'s Ring',
                    x: 5708,
                    y: 2409,
                    color: 'yellow',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('14/Explorer\'s_ring_2.png'), aWiki('Explorer\'s ring')),
                            p(text('Requires completing '), aWiki('medium Lumbridge & Draynor Diary'))
                        );
                    }
                },
                {
                    name: 'Lumbridge Home Teleport',
                    x: 6243,
                    y: 2632,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('e2/Home_Teleport.png'), aWiki('Lumbridge Home Teleport')),
                            p(text('10s to cast')),
                            p(text('30min cooldown'))
                        );
                    }
                },
                {
                    name: 'Varrock Teleport',
                    x: 6182,
                    y: 2000,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('c5/Varrock_Teleport.png'), aWiki('Varrock Teleport')),
                            reqMagic(25),
                            p(runeReq('air', 3), runeReq('fire', 1), runeReq('law', 1))
                        );
                    }
                },
                {
                    name: 'Varrock Teleport (Toggle-location)',
                    x: 6036,
                    y: 1866,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('c5/Varrock_Teleport.png'), aWiki('Varrock Teleport'), text(' (Toggle-location)')),
                            p(text('Requires completing '), aWiki('Medium Varrock Diary')),
                            reqMagic(25),
                            p(runeReq('air', 3), runeReq('fire', 1), runeReq('law', 1))
                        );
                    }
                },
                {
                    name: 'Lumbridge Teleport',
                    x: 6212,
                    y: 2634,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('f8/Lumbridge_Teleport.png'), aWiki('Lumbridge Teleport')),
                            reqMagic(31),
                            p(runeReq('air', 3), runeReq('earth', 1), runeReq('law', 1))
                        );
                    }
                },
                {
                    name: 'Falador Teleport',
                    x: 5436,
                    y: 2148,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('06/Falador_Teleport.png'), aWiki('Falador Teleport')),
                            reqMagic(37),
                            p(runeReq('air', 3), runeReq('water', 1), runeReq('law', 1))
                        );
                    }
                },
                {
                    name: 'Teleport to House (Rimmington)',
                    x: 5400,
                    y: 2614,
                    color: 'blue',
                    renderTooltip: () => teleToHouseTemplate('Rimmington')
                },
                {
                    name: 'Teleport to House (Taverley)',
                    x: 5215,
                    y: 1894,
                    color: 'blue',
                    renderTooltip: () => teleToHouseTemplate('Taverley')
                },
                {
                    name: 'Teleport to House (Pollnivneach)',
                    x: 6561,
                    y: 3287,
                    color: 'blue',
                    renderTooltip: () => teleToHouseTemplate('Pollnivneach')
                },
                {
                    name: 'Teleport to House (Yanille)',
                    x: 4176,
                    y: 2998,
                    color: 'blue',
                    renderTooltip: () => teleToHouseTemplate('Yanille')
                },
                {
                    name: 'Teleport to House (Brimhaven)',
                    x: 4810,
                    y: 2756,
                    color: 'blue',
                    renderTooltip: () => teleToHouseTemplate('Brimhaven')
                },
                {
                    name: 'Teleport to House (Hosidius)',
                    x: 1768,
                    y: 1736,
                    color: 'blue',
                    renderTooltip: () => teleToHouseTemplate('Hosidius')
                },
                {
                    name: 'Teleport to House (Fremennik Province)',
                    x: 4553,
                    y: 1394,
                    color: 'blue',
                    renderTooltip: () => teleToHouseTemplate('Fremennik Province')
                },
                {
                    name: 'Teleport to House (Prifddinas)',
                    x: 3183,
                    y: 2308,
                    color: 'blue',
                    renderTooltip: () => teleToHouseTemplate('Prifddinas')
                },
                {
                    name: 'Camelot Teleport',
                    x: 4818,
                    y: 1862,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('68/Camelot_Teleport.png'), aWiki('Camelot Teleport')),
                            reqMagic(45),
                            p(runeReq('air', 5), runeReq('law', 1))
                        );
                    }
                },
                {
                    name: 'Camelot Teleport (Toggle-location)',
                    x: 4718,
                    y: 1813,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('68/Camelot_Teleport.png'), aWiki('Camelot Teleport'), text(' (Toggle-location)')),
                            p(text('Requires completing '), aWiki('Hard Kandarin Diary')),
                            reqMagic(45),
                            p(runeReq('air', 5), runeReq('law', 1))
                        );
                    }
                },
                {
                    name: 'Ardougne Teleport',
                    x: 4528,
                    y: 2366,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('05/Ardougne_Teleport.png'), aWiki('Ardougne Teleport')),
                            p(text('Requires completing '), aWiki('Plague City')),
                            reqMagic(51),
                            p(runeReq('water', 2), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Watchtower Teleport',
                    x: 4186,
                    y: 2935,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('91/Watchtower_Teleport.png'), aWiki('Watchtower Teleport')),
                            p(text('Requires completing '), aWiki('Watchtower')),
                            reqMagic(58),
                            p(runeReq('earth', 2), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Watchtower Teleport (Toggle-location)',
                    x: 4273,
                    y: 3017,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('91/Watchtower_Teleport.png'), aWiki('Watchtower Teleport'), text(' (Toggle-location)')),
                            p(text('Requires completing '), aWiki('Hard Ardougne Diary')),
                            reqMagic(58),
                            p(runeReq('earth', 2), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Trollheim Teleport',
                    x: 5220,
                    y: 1251,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('41/Trollheim_Teleport.png'), aWiki('Trollheim Teleport')),
                            p(text('Requires completing '), aWiki('Eadgar\'s Ruse')),
                            reqMagic(61),
                            p(runeReq('fire', 2), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Ape Atoll Teleport',
                    x: 4942,
                    y: 3927,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('76/Ape_Atoll_Teleport_(standard).png'), aWiki('Ape Atoll Teleport (standard)')),
                            p(text('Requires part of '), aWiki('Recipe for Disaster')),
                            reqMagic(74),
                            p(runeReq('fire', 2), runeReq('water', 2), runeReq('law', 2), runeReq('banana', 1))
                        );
                    }
                },
                {
                    name: 'Kourend Castle Teleport',
                    x: 1431,
                    y: 1268,
                    color: 'aqua',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('1b/Kourend_Castle_Teleport.png'), aWiki('Kourend Castle Teleport')),
                            p(text('Requires reading '), aWiki('Transportation incantations')),
                            reqMagic(69),
                            p(runeReq('fire', 5), runeReq('water', 4), runeReq('law', 2), runeReq('soul', 2))
                        );
                    }
                },
                {
                    name: 'Edgeville Home Teleport',
                    x: 5822,
                    y: 1832,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('e2/Home_Teleport.png'), aWiki('Edgeville Home Teleport')),
                            reqAncientMagicks(),
                            p(text('10s to cast')),
                            p(text('30min cooldown'))
                        );
                    }
                },
                {
                    name: 'Paddewwa Teleport',
                    x: 5828,
                    y: 1873,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('05/Paddewwa_Teleport.png'), aWiki('Paddewwa Teleport')),
                            reqAncientMagicks(),
                            reqMagic(54),
                            p(runeReq('air', 1), runeReq('fire', 1), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Senntisten Teleport',
                    x: 6606,
                    y: 2061,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('94/Senntisten_Teleport.png'), aWiki('Senntisten Teleport')),
                            reqAncientMagicks(),
                            reqMagic(60),
                            p(runeReq('law', 2), runeReq('soul', 1))
                        );
                    }
                },
                {
                    name: 'Kharyll Teleport',
                    x: 7068,
                    y: 1775,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('b0/Kharyrll_Teleport.png'), aWiki('Kharyll Teleport')),
                            reqAncientMagicks(),
                            reqMagic(66),
                            p(runeReq('blood', 1), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Lassar Teleport',
                    x: 5564,
                    y: 1859,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('40/Lassar_Teleport.png'), aWiki('Lassar Teleport')),
                            reqAncientMagicks(),
                            reqMagic(72),
                            p(runeReq('water', 4), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Dareeyak Teleport',
                    x: 5465,
                    y: 1205,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('11/Dareeyak_Teleport.png'), aWiki('Dareeyak Teleport')),
                            reqAncientMagicks(),
                            reqMagic(78),
                            p(runeReq('air', 2), runeReq('fire', 3), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Carrallangar Teleport',
                    x: 6015,
                    y: 1295,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('1e/Carrallangar_Teleport.png'), aWiki('Carrallangar Teleport')),
                            reqAncientMagicks(),
                            reqMagic(84),
                            p(runeReq('law', 2), runeReq('soul', 2))
                        );
                    }
                },
                {
                    name: 'Annakarl Teleport',
                    x: 6413,
                    y: 629,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('62/Annakarl_Teleport.png'), aWiki('Annakarl Teleport')),
                            reqAncientMagicks(),
                            reqMagic(90),
                            p(runeReq('blood', 2), runeReq('law', 2))
                        );
                    }
                },
                {
                    name: 'Ghorrock Teleport',
                    x: 5458,
                    y: 670,
                    color: 'purple',
                    renderTooltip: () => {
                        return div(
                            p(imgWiki('46/Ghorrock_Teleport.png'), aWiki('Ghorrock Teleport')),
                            reqAncientMagicks(),
                            reqMagic(96),
                            p(runeReq('water', 8), runeReq('law', 2))
                        );
                    }
                }
            ];

            function draw() {
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (mapImgLoaded) {
                    // TODO: Profile whether it makes sense to only draw what the user sees VS everything
                    ctx.drawImage(mapImg, mapX, mapY, mapImg.width * mapScale, mapImg.height * mapScale);
                } else {
                    ctx.fillStyle = 'white';
                    ctx.font = '50px serif';
                    ctx.fillText('Loading...', 10, 60);
                }

                poi.forEach(item => {
                    ctx.fillStyle = item.color;
                    ctx.beginPath();
                    ctx.arc(item.x * mapScale + mapX, item.y * mapScale + mapY, poiRadius, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }

            function onResize(e) {
                canvas.width  = window.innerWidth;
                canvas.height = window.innerHeight;
                draw();
            }

            window.addEventListener('resize', onResize, false);
            onResize();

            mapImg.addEventListener('load', e => {
                mapImgLoaded = true;
                draw();
            });

            dialogCloseButton.addEventListener('click', e => dialog.style.display = 'none');

            canvas.addEventListener('mousedown', e => {
                isDragging = true
                prevMouseX = e.clientX;
                prevMouseY = e.clientY;

                // Print clicks so adding new POIs is easier
                console.log("clickX=" + ((mapX - e.clientX) / -mapScale) + " clickY=" + ((mapY - e.clientY) / -mapScale));
            });
            canvas.addEventListener('mouseup', e => isDragging = false);
            canvas.addEventListener('mouseleave', e => isDragging = false);
            canvas.addEventListener('mousemove', e => {
                if (isDragging) {
                    var deltaX = e.clientX - prevMouseX;
                    var deltaY = e.clientY - prevMouseY;
                    prevMouseX = e.clientX;
                    prevMouseY = e.clientY;

                    mapX += deltaX;
                    mapY += deltaY;

                    draw();
                } else {
                    poi.forEach(item => {
                        var itemX = item.x * mapScale + mapX;
                        var itemY = item.y * mapScale + mapY;

                        if (e.clientX > itemX - poiRadius && e.clientX < itemX + poiRadius && e.clientY > itemY - poiRadius && e.clientY < itemY + poiRadius) {
                            dialog.style.top = e.clientY + 'px';
                            dialog.style.left = e.clientX + 'px';
                            dialog.style.display = 'block';

                            if ('renderTooltip' in item) {
                                dialog.firstChild.remove();
                                dialog.insertBefore(item.renderTooltip(), dialog.firstChild);
                            } else {
                                dialog.firstChild.remove();
                                dialog.insertBefore(p(aWiki(item.name)), dialog.firstChild);
                            }
                        }
                    })
                }
            });
            canvas.addEventListener('wheel', e => {
                var oldMapScale = mapScale;

                // https://stackoverflow.com/questions/5527601/normalizing-mousewheel-speed-across-browsers
                var deltaY = Math.sign(e.deltaY);

                mapScale += scaleIncrements * -deltaY;
                if (mapScale <= scaleMin) {
                    mapScale = scaleMin;
                }

                mapX -= ((mapX - e.clientX) / oldMapScale) * (scaleIncrements * deltaY);
                mapY -= ((mapY - e.clientY) / oldMapScale) * (scaleIncrements * deltaY);

                draw();
            });

            // TODO: Touch events
            // https://developer.mozilla.org/en-US/docs/Web/API/Touch_events
        })();
    </script>
</body>
